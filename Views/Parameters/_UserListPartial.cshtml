@model Dastone.Models.UserListPartialViewModel

<div class="card" style="margin-top: 15px;">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h4 class="card-title">Danışman Listesi</h4>
            </div>
            <div class="col-auto">
                <div class="input-group">
                </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th>Kullanıcı Adı</th>
                        <th>Adı Soyadı</th>
                        <th>E-posta</th>
                        <th>Rol</th>
                        <th>Oluşturulma Tarihi</th>
                        <th>Eylemler</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    @if (Model.Users != null && Model.Users.Any())
                    {
                        @foreach (var user in Model.Users)
                        {
                            <tr class="user-row" data-user-id="@user.UserID" style="cursor: pointer;">
                                <td>@user.Username</td>
                                <td>@($"{user.FirstName} {user.LastName}")</td>
                                <td>@user.Email</td>
                                <td>@user.Role?.RoleName</td>
                                <td>@user.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-soft-danger delete-user-btn" data-user-id="@user.UserID">
                                        Sil
                                    </button>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center">Hiç kullanıcı bulunamadı.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <!-- Sayfalama -->
        <div class="d-flex justify-content-between align-items-center mt-3">
            <small class="text-muted">Sayfa @Model.PageNumber / @Model.TotalPages</small>
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item @(Model.PageNumber <= 1 ? "disabled" : "")">
                        <a class="page-link load-user-page" href="#" data-page="@(Model.PageNumber - 1)" data-query="@Model.SearchQuery">Önceki</a>
                    </li>
                    @for (int i = 1; i <= Model.TotalPages; i++)
                    {
                        <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                            <a class="page-link load-user-page" href="#" data-page="@i" data-query="@Model.SearchQuery">@i</a>
                        </li>
                    }
                    <li class="page-item @(Model.PageNumber >= Model.TotalPages ? "disabled" : "")">
                        <a class="page-link load-user-page" href="#" data-page="@(Model.PageNumber + 1)" data-query="@Model.SearchQuery">Sonraki</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<script>
    (function () {
        console.log('_UserListPartial.cshtml loaded');

        // Arama butonu click olayı
        $('#userSearchButton').off('click').on('click', function () {
            const query = $('#userSearchInput').val();
            loadUserList(1, query);
        });

        // Arama inputu Enter tuşu olayı
        $('#userSearchInput').off('keyup').on('keyup', function (e) {
            if (e.key === 'Enter') {
                const query = $(this).val();
                loadUserList(1, query);
            }
        });

        // Sayfalama click olayı
        $('#userTableBody').closest('.card-body').find('.load-user-page').off('click').on('click', function (e) {
            e.preventDefault();
            const page = $(this).data('page');
            const query = $(this).data('query');
            loadUserList(page, query);
        });

        function loadUserList(page, query) {
            console.log(`Loading user list for page: ${page}, query: ${query}`);
            const targetDiv = $(`#userDefinitions`);
            $.ajax({
                url: '@Url.Action("GetUsersForTab", "Parameters")',
                type: 'GET',
                data: {
                    pageNumber: page,
                    pageSize: @Model.PageSize,
                    searchQuery: query
                },
                success: function (data) {
                    console.log(`Kullanıcı listesi başarıyla yüklendi.`, data);
                    targetDiv.html(data);
                    $.validator.unobtrusive.parse(targetDiv);
                },
                error: function (xhr, status, error) {
                    console.error(`Kullanıcı listesi yüklenirken hata oluştu:`, error);
                    targetDiv.html(`<div class="alert alert-danger">Kullanıcılar yüklenemedi: ${xhr.statusText}</div>`);
                }
            });
        }
    })();
</script>