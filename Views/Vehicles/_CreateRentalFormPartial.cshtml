@model Dastone.Models.CreateRentalViewModel

<form id="createRentalForm" asp-action="CreateRental" asp-controller="Vehicles" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <div class="mb-3">
        <label for="SelectedVehicleDisplay" class="form-label">Seçilen Araç</label>
        <div class="input-group">
            <input type="text" id="SelectedVehicleDisplay" class="form-control" readonly placeholder="Araç Seçilmedi" />
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#carSelectionModal">
                Araç Seç
            </button>
        </div>
        <input type="hidden" asp-for="AracID" id="SelectedVehicleId" />
        <span asp-validation-for="AracID" class="text-danger"></span>
    </div>
    <div class="mb-3">
        <label for="SelectedCustomerDisplay" class="form-label">Seçilen Müşteri</label>
        <div class="input-group">
            <input type="text" id="SelectedCustomerDisplay" class="form-control" readonly placeholder="Müşteri Seçilmedi" />
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#customerSelectionModal">
                Müşteri Seç
            </button>
        </div>
        <input type="hidden" asp-for="MusteriID" id="SelectedCustomerId" />
        <span asp-validation-for="MusteriID" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="BaslangicTarihi" class="form-label">Başlangıç Tarihi</label>
        <input asp-for="BaslangicTarihi" type="date" class="form-control" />
        <span asp-validation-for="BaslangicTarihi" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="BitisTarihi" class="form-label">Bitiş Tarihi</label>
        <input asp-for="BitisTarihi" type="date" class="form-control" />
        <span asp-validation-for="BitisTarihi" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="KiralamaSozlesmeleriDosyalari" class="form-label">Kiralama Sözleşmeleri</label>
        <input asp-for="KiralamaSozlesmeleriDosyalari" type="file" id="KiralamaSozlesmeleri" multiple class="form-control" />
        <small class="form-text text-muted">Birden fazla sözleşme dosyası seçebilirsiniz.</small>
        <span asp-validation-for="KiralamaSozlesmeleriDosyalari" class="text-danger"></span>
    </div>

    <button type="submit" class="btn btn-primary" id="submitRentalForm">Kiralama Oluştur</button>
    <div id="formMessageRental" class="mt-3 form-message"></div>
    ```

</form>

<div class="modal fade" id="carSelectionModal" tabindex="-1" role="dialog" aria-labelledby="carSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title m-0" id="carSelectionModalLabel">Araç Seçimi</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Araç Marka, Model veya Plaka ile Ara..." id="carSearchInput">
                    <button type="button" class="btn btn-primary" id="carSearchButton">Ara</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Marka</th>
                                <th>Model</th>
                                <th>Plaka</th>
                                <th>Kiralama Bedeli</th>
                                <th>Seç</th>
                            </tr>
                        </thead>
                        <tbody id="carTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-soft-secondary btn-sm" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="customerSelectionModal" tabindex="-1" role="dialog" aria-labelledby="customerSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title m-0" id="customerSelectionModalLabel">Müşteri Seçimi</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Müşteri Ad, Soyad veya TC No ile Ara..." id="customerSearchInput">
                    <button type="button" class="btn btn-primary" id="customerSearchButton">Ara</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Adı</th>
                                <th>Seç</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-soft-secondary btn-sm" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        console.log('CreateRentalFormPartial loaded with new modal logic at:', new Date().toISOString());

        window.initializeDateValidation = function () {
            console.log('Initializing date validation');
            var today = new Date().toISOString().split('T')[0];

            $('#BaslangicTarihi').off('change.rentalDateValidation').on('change.rentalDateValidation', function () {
                var startDate = $(this).val();
                $('#BitisTarihi').attr('min', startDate || today);

                if (startDate && $('#BitisTarihi').val() < startDate) {
                    $('#BitisTarihi').val(startDate);
                }
                console.log('Start Date Changed:', startDate);
            });

            var initialStartDate = $('#BaslangicTarihi').val();
            if (initialStartDate) {
                $('#BitisTarihi').attr('min', initialStartDate);
            } else {
                $('#BitisTarihi').attr('min', today);
            }
        };

        $('#carSelectionModal').off('show.bs.modal.car').on('show.bs.modal.car', function () {
            console.log('carSelectionModal shown, loading cars...');
            $('#carSearchInput').val('');
            loadCars('');
        });

        $('#carSearchButton').off('click.car').on('click.car', function () {
            var searchTerm = $('#carSearchInput').val();
            loadCars(searchTerm);
        });

        $('#carSearchInput').off('keyup.car').on('keyup.car', function (e) {
            if (e.key === 'Enter') {
                var searchTerm = $(this).val();
                loadCars(searchTerm);
            }
        });

        function loadCars(searchTerm) {
            $.ajax({
                url: '@Url.Action("GetVehicles", "Vehicles")',
                type: 'GET',
                data: { query: searchTerm },
                success: function (data) {
                    console.log('Araçlar AJAX isteği başarılı. Gelen veri:', data);
                    var carTableBody = $('#carTableBody');
                    carTableBody.empty();
                    if (data && data.length > 0) {
                        $.each(data, function (index, car) {
                            var row = `
                                <tr>
                                    <td>${car.marka || 'N/A'}</td>
                                    <td>${car.model || 'N/A'}</td>
                                    <td>${car.plaka || 'N/A'}</td>
                                    <td>${car.kiralamaBedeli !== null ? car.kiralamaBedeli : 'N/A'} TL</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-success select-car-btn"
                                                data-car-id="${car.id}"
                                                data-car-display="${car.marka} ${car.model} (${car.plaka})">
                                            Seç
                                        </button>
                                    </td>
                                </tr>
                            `;
                            carTableBody.append(row);
                        });
                    } else {
                        carTableBody.append('<tr><td colspan="5" class="text-center">Hiç araç bulunamadı.</td></tr>');
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Araçlar yüklenirken bir hata oluştu:", error);
                    $('#carTableBody').empty().append('<tr><td colspan="5" class="text-center text-danger">Araçlar yüklenemedi.</td></tr>');
                }
            });
        }

        $(document).off('click.selectCar').on('click.selectCar', '.select-car-btn', function () {
            var carId = $(this).data('car-id');
            var carDisplay = $(this).data('car-display');

            $('#SelectedVehicleId').val(carId);
            $('#SelectedVehicleDisplay').val(carDisplay);
            $('#SelectedVehicleId').valid();

            $('#carSelectionModal').modal('hide');
            console.log('Araç Seçildi:', { id: carId, display: carDisplay });
        });

        $('#customerSelectionModal').off('show.bs.modal.customer').on('show.bs.modal.customer', function () {
            console.log('customerSelectionModal shown, loading customers...');
            $('#customerSearchInput').val('');
            loadCustomers('');
        });

        $('#customerSearchButton').off('click.customer').on('click.customer', function () {
            var searchTerm = $('#customerSearchInput').val();
            loadCustomers(searchTerm);
        });

        $('#customerSearchInput').off('keyup.customer').on('keyup.customer', function (e) {
            if (e.key === 'Enter') {
                var searchTerm = $(this).val();
                loadCustomers(searchTerm);
            }
        });

        function loadCustomers(searchTerm) {
            $.ajax({
                url: '@Url.Action("GetCustomers", "Vehicles")',
                type: 'GET',
                data: { query: searchTerm },
                success: function (data) {
                    console.log('Müşteriler AJAX isteği başarılı. Gelen veri:', data);
                    var customerTableBody = $('#customerTableBody');
                    customerTableBody.empty();
                    if (data && data.length > 0) {
                        $.each(data, function (index, customer) {
                            var row = `
                                <tr>
                                    <td>${customer.ad || 'N/A'} ${customer.soyad || ''} (${customer.kimlikNo || 'N/A'})</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-success select-customer-btn"
                                                data-customer-id="${customer.id}"
                                                data-customer-display="${customer.ad} ${customer.soyad} (${customer.kimlikNo})">
                                            Seç
                                        </button>
                                    </td>
                                </tr>
                            `;
                            customerTableBody.append(row);
                        });
                    } else {
                        customerTableBody.append('<tr><td colspan="5" class="text-center">Hiç müşteri bulunamadı.</td></tr>');
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Müşteriler yüklenirken bir hata oluştu:", error);
                    $('#customerTableBody').empty().append('<tr><td colspan="5" class="text-center text-danger">Müşteriler yüklenemedi.</td></tr>');
                }
            });
        }

        $(document).off('click.selectCustomer').on('click.selectCustomer', '.select-customer-btn', function () {
            var customerId = $(this).data('customer-id');
            var customerDisplay = $(this).data('customer-display');

            $('#SelectedCustomerId').val(customerId);
            $('#SelectedCustomerDisplay').val(customerDisplay);
            $('#SelectedCustomerId').valid();

            $('#customerSelectionModal').modal('hide');
            console.log('Müşteri Seçildi:', { id: customerId, display: customerDisplay });
        });

        $('#createRentalForm').off('reset.rentalForm').on('reset.rentalForm', function () {
            console.log('Kiralama formu sıfırlandı.');
            $('#SelectedVehicleDisplay').val('Araç Seçilmedi');
            $('#SelectedVehicleId').val('');
            $('#SelectedCustomerDisplay').val('Müşteri Seçilmedi');
            $('#SelectedCustomerId').val('');
            $(this).find('.text-danger').empty();
            $(this).find('.form-message').empty().removeClass('alert alert-danger alert-success');
        });

        initializeDateValidation();
    })();
</script>
