@model Dastone.Models.CezaViewModel

<form id="createPenaltyForm" asp-action="AddPenalty" asp-controller="Vehicles" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()

    <div class="mb-3">
        <label for="SelectedVehicleDisplayPenalty" class="form-label">Seçilen Araç</label>
        <div class="input-group">
            <input type="text" id="SelectedVehicleDisplayPenalty" class="form-control" readonly placeholder="Araç Seçilmedi" asp-for="SelectedVehicleDisplayPenalty"/> @* Yeni asp-for *@
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#carSelectionModalPenalty">
                Araç Seç
            </button>
        </div>
        <input type="hidden" asp-for="AracID" id="SelectedVehicleIdPenalty" />
        <span asp-validation-for="AracID" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label for="SelectedCustomerDisplayPenalty" class="form-label">Seçilen Müşteri</label>
        <div class="input-group">
            <input type="text" id="SelectedCustomerDisplayPenalty" class="form-control" readonly placeholder="Müşteri Seçilmedi" asp-for="SelectedCustomerDisplayPenalty" /> @* Yeni asp-for *@
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#customerSelectionModalPenalty">
                Müşteri Seç
            </button>
        </div>
        <input type="hidden" asp-for="MusteriID" id="SelectedCustomerIdPenalty" />
        <span asp-validation-for="MusteriID" class="text-danger"></span>
    </div>

    @* Ceza Tanımı Seçim Alanı *@
    <div class="mb-3">
        <label for="SelectedPenaltyDefinitionDisplay" class="form-label">Ceza Tanımı</label>
        <div class="input-group">
            <input type="text" id="SelectedPenaltyDefinitionDisplay" class="form-control" readonly placeholder="Ceza Tanımı Seçilmedi" asp-for="SelectedPenaltyDefinitionDisplay" /> @* Yeni asp-for *@
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#penaltyDefinitionSelectionModal">
                Ceza Tanımı Seç
            </button>
        </div>
        <input type="hidden" asp-for="CezaTanimiID" id="SelectedPenaltyDefinitionId" />
        <span asp-validation-for="CezaTanimiID" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="CezaTarihi" class="form-label"></label>
        <input asp-for="CezaTarihi" type="date" class="form-control" />
        <span asp-validation-for="CezaTarihi" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Tutar" class="form-label"></label>
        <input asp-for="Tutar" type="number" step="0.01" class="form-control" />
        <span asp-validation-for="Tutar" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Aciklama" class="form-label"></label>
        <textarea asp-for="Aciklama" class="form-control" rows="3"></textarea>
        <span asp-validation-for="Aciklama" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="CezaYeri" class="form-label"></label>
        <input asp-for="CezaYeri" type="text" class="form-control" />
        <span asp-validation-for="CezaYeri" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="CezaBelgesiFile" class="form-label"></label>
        <input type="file" asp-for="CezaBelgesiFile" class="form-control" />
        <small class="form-text text-muted">Ceza belgesi dosyasını yükleyebilirsiniz.</small>
        <span asp-validation-for="CezaBelgesiFile" class="text-danger"></span>
        @if (!string.IsNullOrEmpty(Model.ExistingCezaBelgesi)) // Edit işlemi için mevcut belgeyi göster
        {
            <div>
                Mevcut Belge: <a href="@Model.ExistingCezaBelgesi" target="_blank">Görüntüle</a>
            </div>
        }
    </div>

    <div class="mb-3 form-check">
        <input type="checkbox" asp-for="Odendi" class="form-check-input" />
        <label asp-for="Odendi" class="form-check-label"></label>
    </div>

    <button type="submit" class="btn btn-primary" id="submitPenaltyForm">Ceza Oluştur</button>
    <div id="formMessagePenalty" class="mt-3 form-message"></div>
</form>

<div class="modal fade" id="carSelectionModalPenalty" tabindex="-1" role="dialog" aria-labelledby="carSelectionModalPenaltyLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title m-0" id="carSelectionModalPenaltyLabel">Araç Seçimi</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Araç Marka, Model veya Plaka ile Ara..." id="carSearchInputPenalty">
                    <button class="btn btn-primary" type="button" id="carSearchButtonPenalty">Ara</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Marka</th>
                                <th>Model</th>
                                <th>Plaka</th>
                                <th>Kiralama Bedeli</th>
                                <th>Seç</th>
                            </tr>
                        </thead>
                        <tbody id="carTableBodyPenalty">
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-soft-secondary btn-sm" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="customerSelectionModalPenalty" tabindex="-1" role="dialog" aria-labelledby="customerSelectionModalPenaltyLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title m-0" id="customerSelectionModalPenaltyLabel">Müşteri Seçimi</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Müşteri Ad, Soyad veya TC No ile Ara..." id="customerSearchInputPenalty">
                    <button class="btn btn-primary" type="button" id="customerSearchButtonPenalty">Ara</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Adı</th>
                                <th>Soyadı</th>
                                <th>TC Kimlik No</th>
                                <th>Telefon</th>
                                <th>Seç</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBodyPenalty">
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-soft-secondary btn-sm" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="penaltyDefinitionSelectionModal" tabindex="-1" role="dialog" aria-labelledby="penaltyDefinitionSelectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title m-0" id="penaltyDefinitionSelectionModalLabel">Ceza Tanımı Seçimi</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Ceza Kodu veya Açıklama ile Ara..." id="penaltyDefSearchInputModal">
                    <button class="btn btn-primary" type="button" id="penaltyDefSearchButtonModal">Ara</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Ceza Kodu</th>
                                <th>Kısa Açıklama</th>
                                <th>Seç</th>
                            </tr>
                        </thead>
                        <tbody id="penaltyDefinitionTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-soft-secondary btn-sm" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        console.log('CreatePenaltyFormPartial loaded at:', new Date().toISOString());

        // Form yüklendiğinde gizli ID alanlarını ve display alanlarını sıfırla
        // ViewModel'den gelen initial değerler (örn: CezaTarihi) burada korunacaktır.
        // Sadece modal seçim alanlarını ve varsa hata sonrası kalan değerleri sıfırlarız.
        $('#SelectedVehicleIdPenalty').val('');
        $('#SelectedVehicleDisplayPenalty').val('Araç Seçilmedi');
        $('#SelectedCustomerIdPenalty').val('');
        $('#SelectedCustomerDisplayPenalty').val('Müşteri Seçilmedi');
        $('#SelectedPenaltyDefinitionId').val('');
        $('#SelectedPenaltyDefinitionDisplay').val('Ceza Tanımı Seçilmedi');

        // Ceza Tarihi için varsayılan olarak bugünün tarihini ayarla (ViewModel'de de var, burada client side override)
        function setPenaltyDateToToday() {
            var today = new Date().toISOString().split('T')[0];
            if (!$('#CezaTarihi').val()) { // Eğer zaten bir değer yoksa (örneğin ViewModel'den gelmediyse)
                $('#CezaTarihi').val(today);
            }
        }

        // Araç Seçim Modalı Fonksiyonları (Ceza Formu için)
        $('#carSelectionModalPenalty').off('show.bs.modal.penaltyCar').on('show.bs.modal.penaltyCar', function () {
            console.log('carSelectionModalPenalty shown, loading cars...');
            $('#carSearchInputPenalty').val(''); // Modalı açarken arama inputunu temizle
            loadCarsPenalty(''); // Modal açıldığında tüm araçları yükle
        });

        $('#carSearchButtonPenalty').off('click.penaltyCar').on('click.penaltyCar', function () {
            var searchTerm = $('#carSearchInputPenalty').val();
            loadCarsPenalty(searchTerm);
        });

        $('#carSearchInputPenalty').off('keyup.penaltyCar').on('keyup.penaltyCar', function (e) {
            if (e.key === 'Enter') {
                var searchTerm = $(this).val();
                loadCarsPenalty(searchTerm);
            }
        });

        function loadCarsPenalty(searchTerm) {
            $.ajax({
                url: '@Url.Action("GetVehicles", "Vehicles")',
                type: 'GET',
                data: { query: searchTerm },
                success: function (data) {
                    console.log('*** Ceza Formu - Araçlar AJAX isteği başarılı. Gelen veri:', data);
                    var carTableBody = $('#carTableBodyPenalty');
                    carTableBody.empty();
                    if (data && data.length > 0) {
                        $.each(data, function (index, car) {
                            var row = `
                                <tr>
                                    <td>${car.marka}</td>
                                    <td>${car.model}</td>
                                    <td>${car.plaka}</td>
                                    <td>${car.kiralamaBedeli !== null ? car.kiralamaBedeli : 'N/A'} TL</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-success select-car-btn-penalty"
                                                data-car-id="${car.id}"
                                                data-car-display="${car.marka} ${car.model} (${car.plaka})">
                                            Seç
                                        </button>
                                    </td>
                                </tr>
                            `;
                            carTableBody.append(row);
                        });
                    } else {
                        carTableBody.append('<tr><td colspan="5" class="text-center">Hiç araç bulunamadı.</td></tr>');
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Ceza Formu - Araçlar yüklenirken bir hata oluştu:", error);
                    $('#carTableBodyPenalty').empty().append('<tr><td colspan="5" class="text-center text-danger">Araçlar yüklenemedi.</td></tr>');
                }
            });
        }

        // Araç Seç butonu click event'i (Ceza Formu için)
        $(document).off('click.selectCarPenalty').on('click.selectCarPenalty', '.select-car-btn-penalty', function () {
            var carId = $(this).data('car-id');
            var carDisplay = $(this).data('car-display');

            $('#SelectedVehicleIdPenalty').val(carId);
            $('#SelectedVehicleDisplayPenalty').val(carDisplay);
            $('#SelectedVehicleIdPenalty').valid(); // Validasyonu tetikle

            $('#carSelectionModalPenalty').modal('hide');
            console.log('Ceza Formu - Araç Seçildi:', { id: carId, display: carDisplay });
        });


        // Müşteri Seçim Modalı Fonksiyonları (Ceza Formu için)
        $('#customerSelectionModalPenalty').off('show.bs.modal.penaltyCustomer').on('show.bs.modal.penaltyCustomer', function () {
            console.log('customerSelectionModalPenalty shown, loading customers...');
            $('#customerSearchInputPenalty').val(''); // Modalı açarken arama inputunu temizle
            loadCustomersPenalty(''); // Modal açıldığında tüm müşterileri yükle
        });

        $('#customerSearchButtonPenalty').off('click.penaltyCustomer').on('click.penaltyCustomer', function () {
            var searchTerm = $('#customerSearchInputPenalty').val();
            loadCustomersPenalty(searchTerm);
        });

        $('#customerSearchInputPenalty').off('keyup.penaltyCustomer').on('keyup.penaltyCustomer', function (e) {
            if (e.key === 'Enter') {
                var searchTerm = $(this).val();
                loadCustomersPenalty(searchTerm);
            }
        });

        function loadCustomersPenalty(searchTerm) {
            $.ajax({
                url: '@Url.Action("GetCustomers", "Vehicles")',
                type: 'GET',
                data: { query: searchTerm },
                success: function (data) {
                    console.log('*** Ceza Formu - Müşteriler AJAX isteği başarılı. Gelen veri:', data);
                    var customerTableBody = $('#customerTableBodyPenalty');
                    customerTableBody.empty();
                    if (data && data.length > 0) {
                        $.each(data, function (index, customer) {
                            var row = `
                                <tr>
                                    <td>${customer.ad}</td>
                                    <td>${customer.soyad}</td>
                                    <td>${customer.kimlikNo}</td>
                                    <td>${customer.telefon}</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-success select-customer-btn-penalty"
                                                data-customer-id="${customer.id}"
                                                data-customer-display="${customer.ad} ${customer.soyad} (${customer.kimlikNo})">
                                            Seç
                                        </button>
                                    </td>
                                </tr>
                            `;
                            customerTableBody.append(row);
                        });
                    } else {
                        customerTableBody.append('<tr><td colspan="5" class="text-center">Hiç müşteri bulunamadı.</td></tr>');
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Ceza Formu - Müşteriler yüklenirken bir hata oluştu:", error);
                    $('#customerTableBodyPenalty').empty().append('<tr><td colspan="5" class="text-center text-danger">Müşteriler yüklenemedi.</td></tr>');
                }
            });
        }

        // Müşteri Seç butonu click event'i (Ceza Formu için)
        $(document).off('click.selectCustomerPenalty').on('click.selectCustomerPenalty', '.select-customer-btn-penalty', function () {
            var customerId = $(this).data('customer-id');
            var customerDisplay = $(this).data('customer-display');

            $('#SelectedCustomerIdPenalty').val(customerId);
            $('#SelectedCustomerDisplayPenalty').val(customerDisplay);
            $('#SelectedCustomerIdPenalty').valid(); // Validasyonu tetikle

            $('#customerSelectionModalPenalty').modal('hide');
            console.log('Ceza Formu - Müşteri Seçildi:', { id: customerId, display: customerDisplay });
        });

        // Ceza Tanımı Seçim Modalı Fonksiyonları
        $('#penaltyDefinitionSelectionModal').off('show.bs.modal.penaltyDef').on('show.bs.modal.penaltyDef', function () {
            console.log('penaltyDefinitionSelectionModal shown, loading penalty definitions...');
            $('#penaltyDefSearchInputModal').val(''); // Modalı açarken arama inputunu temizle
            loadPenaltyDefinitionsModal(''); // Modal açıldığında tüm ceza tanımlarını yükle
        });

        $('#penaltyDefSearchButtonModal').off('click.penaltyDef').on('click.penaltyDef', function () {
            var searchTerm = $('#penaltyDefSearchInputModal').val();
            loadPenaltyDefinitionsModal(searchTerm);
        });

        $('#penaltyDefSearchInputModal').off('keyup.penaltyDef').on('keyup.penaltyDef', function (e) {
            if (e.key === 'Enter') {
                var searchTerm = $(this).val();
                loadPenaltyDefinitionsModal(searchTerm);
            }
        });

        function loadPenaltyDefinitionsModal(searchTerm) {
            $.ajax({
                url: '@Url.Action("GetPenaltyDefinitions", "Parameters")',
                type: 'GET',
                data: { query: searchTerm },
                success: function (data) {
                    console.log('*** Ceza Formu - Ceza Tanımları AJAX isteği başarılı. Gelen veri:', data);
                    var penaltyDefinitionTableBody = $('#penaltyDefinitionTableBody');
                    penaltyDefinitionTableBody.empty();
                    if (data && data.length > 0) {
                        $.each(data, function (index, penaltyDef) {
                            var row = `
                                <tr>
                                    <td>${penaltyDef.cezaKodu}</td>
                                    <td>${penaltyDef.kisaAciklama}</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-success select-penalty-def-btn"
                                                data-penalty-def-id="${penaltyDef.id}" @* Burası cezaTanimiID yerine id olmalı *@
                                                data-penalty-def-display="${penaltyDef.cezaKodu} - ${penaltyDef.kisaAciklama}">
                                            Seç
                                        </button>
                                    </td>
                                </tr>
                            `;
                            penaltyDefinitionTableBody.append(row);
                        });
                    } else {
                        penaltyDefinitionTableBody.append('<tr><td colspan="3" class="text-center">Hiç ceza tanımı bulunamadı.</td></tr>');
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Ceza Formu - Ceza Tanımları yüklenirken bir hata oluştu:", error);
                    $('#penaltyDefinitionTableBody').empty().append('<tr><td colspan="3" class="text-center text-danger">Ceza Tanımları yüklenemedi.</td></tr>');
                }
            });
        }

        // Ceza Tanımı Seç butonu click event'i
        $(document).on('click', '.select-penalty-def-btn', function () {
            var penaltyDefId = $(this).data('penalty-def-id');
            var penaltyDefDisplay = $(this).data('penalty-def-display');

            $('#SelectedPenaltyDefinitionId').val(penaltyDefId);
            $('#SelectedPenaltyDefinitionDisplay').val(penaltyDefDisplay);
            $('#SelectedPenaltyDefinitionId').valid(); // Validasyonu tetikle

            $('#penaltyDefinitionSelectionModal').modal('hide');
            console.log('Ceza Formu - Ceza Tanımı Seçildi:', { id: penaltyDefId, display: penaltyDefDisplay });
        });

        // Ceza formu offcanvas açıldığında tarih ve validasyonu başlat
        $(document).off('shown.bs.offcanvas.penalty').on('shown.bs.offcanvas.penalty', '#newPenaltyOffcanvas', function () {
            console.log('newPenaltyOffcanvas shown, initializing penalty form logic...');
            setPenaltyDateToToday(); // Ceza tarihini bugüne ayarla
            // Model validasyonunu tetiklemek için formu yeniden parse etmeye gerek kalmayabilir.
            // Form, ViewModel'den geldiği için client side validasyon kendiliğinden çalışmalı.
        });

        // Form resetlendiğinde display alanlarını sıfırla
        $('#createPenaltyForm').off('reset.penaltyForm').on('reset.penaltyForm', function() {
            console.log('Ceza formu sıfırlandı.');
            $('#SelectedVehicleDisplayPenalty').val('Araç Seçilmedi');
            $('#SelectedVehicleIdPenalty').val('');
            $('#SelectedCustomerDisplayPenalty').val('Müşteri Seçilmedi');
            $('#SelectedCustomerIdPenalty').val('');
            $('#SelectedPenaltyDefinitionDisplay').val('Ceza Tanımı Seçilmedi');
            $('#SelectedPenaltyDefinitionId').val('');
            // Validasyon mesajlarını da temizle
            $(this).find('.text-danger').empty();
            $(this).find('.form-message').empty().removeClass('alert alert-danger alert-success');
        });

        // İlk yüklemede ceza tarihini ayarla
        setPenaltyDateToToday();
    })();
</script>