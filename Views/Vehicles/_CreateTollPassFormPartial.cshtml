@model Dastone.Models.OtoyolGecisi

<form id="createTollPassForm" asp-action="CreateTollPass" asp-controller="Vehicles" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()

    <div class="mb-3">
        <label for="SelectedVehicleDisplayTollPass" class="form-label">Seçilen Araç</label>
        <div class="input-group">
            <input type="text" id="SelectedVehicleDisplayTollPass" class="form-control" readonly placeholder="Araç Seçilmedi" 
                   value="@(Model.AracID.HasValue ? Model.Arac?.Plaka + " - " + Model.Arac?.Marka + " " + Model.Arac?.Model : "")" />
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#carSelectionModalTollPass">
                Araç Seç
            </button>
        </div>
        <input type="hidden" asp-for="AracID" id="SelectedVehicleIdTollPass" 
               value="@(Model.AracID.HasValue ? Model.AracID.Value.ToString() : "")"
               data-val="true" data-val-required="Lütfen bir araç seçin." /> <!-- data-val-required eklendi -->
        <span asp-validation-for="AracID" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label for="SelectedCustomerDisplayTollPass" class="form-label">Seçilen Müşteri</label>
        <div class="input-group">
            <input type="text" id="SelectedCustomerDisplayTollPass" class="form-control" readonly placeholder="Müşteri Seçilmedi" 
                   value="@(Model.MusteriID.HasValue ? Model.Musteri?.DEFINITION_ : "")" />
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#customerSelectionModalTollPass">
                Müşteri Seç
            </button>
        </div>
        <input type="hidden" asp-for="MusteriID" id="SelectedCustomerIdTollPass" 
               value="@(Model.MusteriID.HasValue ? Model.MusteriID.Value.ToString() : "")"
               data-val="true" data-val-required="Lütfen bir müşteri seçin." /> <!-- data-val-required eklendi -->
        <span asp-validation-for="MusteriID" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="GecisTarihi" class="form-label">Geçiş Tarihi</label>
        <input asp-for="GecisTarihi" type="date" class="form-control" />
        <span asp-validation-for="GecisTarihi" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Tutar" class="form-label">Tutar (TL)</label>
        <input asp-for="Tutar" type="number" step="0.01" class="form-control" />
        <span asp-validation-for="Tutar" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="GecisYeri" class="form-label">Geçiş Yeri</label>
        <input asp-for="GecisYeri" type="text" class="form-control" />
        <span asp-validation-for="GecisYeri" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Aciklama" class="form-label">Açıklama</label>
        <textarea asp-for="Aciklama" class="form-control" rows="3"></textarea>
        <span asp-validation-for="Aciklama" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label for="GecisBelgesiFile" class="form-label">Geçiş Belgesi</label>
        <input type="file" id="GecisBelgesiFile" name="gecisBelgesiFile" class="form-control" />
        <small class="form-text text-muted">Geçiş belgesi dosyasını yükleyebilirsiniz.</small>
        <span class="text-danger" data-valmsg-for="gecisBelgesiFile"></span>
    </div>

    <div class="mb-3 form-check">
        <input type="checkbox" asp-for="Odendi" class="form-check-input" />
        <label asp-for="Odendi" class="form-check-label">Ödendi mi?</label>
    </div>

    <button type="submit" class="btn btn-primary" id="submitTollPassForm">Otoyol Geçişi Oluştur</button>
    <div id="formMessageTollPass" class="mt-3 form-message"></div>
</form>

<!-- Araç Seçim Modalı (Otoyol Geçişi Formu için) -->
<div class="modal fade" id="carSelectionModalTollPass" tabindex="-1" role="dialog" aria-labelledby="carSelectionModalTollPassLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title m-0" id="carSelectionModalTollPassLabel">Araç Seçimi</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Araç Marka, Model veya Plaka ile Ara..." id="carSearchInputTollPass">
                    <button class="btn btn-primary" type="button" id="carSearchButtonTollPass">Ara</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Marka</th>
                                <th>Model</th>
                                <th>Plaka</th>
                                <th>Kiralama Bedeli</th>
                                <th>Seç</th>
                            </tr>
                        </thead>
                        <tbody id="carTableBodyTollPass">
                            <!-- Araçlar buraya dinamik olarak yüklenecek -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-soft-secondary btn-sm" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<!-- Müşteri Seçim Modalı (Otoyol Geçişi Formu için) -->
<div class="modal fade" id="customerSelectionModalTollPass" tabindex="-1" role="dialog" aria-labelledby="customerSelectionModalTollPassLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title m-0" id="customerSelectionModalTollPassLabel">Müşteri Seçimi</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Müşteri Ad, Soyad veya TC No ile Ara..." id="customerSearchInputTollPass">
                    <button class="btn btn-primary" type="button" id="customerSearchButtonTollPass">Ara</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Adı</th>
                                <th>Soyadı</th>
                                <th>TC Kimlik No</th>
                                <th>Telefon</th>
                                <th>Seç</th>
                            </tr>
                        </thead>
                        <tbody id="customerTableBodyTollPass">
                            <!-- Müşteriler buraya dinamik olarak yüklenecek -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-soft-secondary btn-sm" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        console.log('CreateTollPassFormPartial loaded at:', new Date().toISOString());

        // Form yüklendiğinde gizli ID alanlarını boşalt veya doğru değeri ayarla
        // Bu, model binder'ın boş değerleri null olarak işlemesini sağlar.
        // Razor zaten modelden gelen null değerleri boş stringe çeviriyor olmalı,
        // ancak emin olmak için JavaScript tarafında da kontrol ediyoruz.
        if (!$('#SelectedVehicleIdTollPass').val()) { // Eğer değeri yoksa (boş string veya undefined)
            $('#SelectedVehicleIdTollPass').val('');
        }
        if (!$('#SelectedCustomerIdTollPass').val()) { // Eğer değeri yoksa
            $('#SelectedCustomerIdTollPass').val('');
        }

        // Geçiş Tarihi için varsayılan olarak bugünün tarihini ayarla
        function setTollPassDateToToday() {
            var today = new Date().toISOString().split('T')[0];
            if (!$('#GecisTarihi').val()) { // Eğer zaten bir değer yoksa
                $('#GecisTarihi').val(today);
            }
        }

        // Araç Seçim Modalı Fonksiyonları (Otoyol Geçişi Formu için)
        $('#carSelectionModalTollPass').on('show.bs.modal', function () {
            console.log('carSelectionModalTollPass shown, loading cars...');
            loadCarsTollPass(''); // Modal açıldığında tüm araçları yükle
        });

        $('#carSearchButtonTollPass').on('click', function () {
            var searchTerm = $('#carSearchInputTollPass').val();
            loadCarsTollPass(searchTerm);
        });

        $('#carSearchInputTollPass').on('keyup', function (e) {
            if (e.key === 'Enter') {
                var searchTerm = $(this).val();
                loadCarsTollPass(searchTerm);
            }
        });

        function loadCarsTollPass(searchTerm) {
            $.ajax({
                url: '@Url.Action("GetVehicles", "Vehicles")', // VehiclesController'daki GetVehicles metodu
                type: 'GET',
                data: { query: searchTerm },
                success: function (data) {
                    console.log('*** Otoyol Geçişi Formu - Araçlar AJAX isteği başarılı. Gelen veri:', data);
                    var carTableBody = $('#carTableBodyTollPass');
                    carTableBody.empty();
                    if (data.length > 0) {
                        $.each(data, function (index, car) {
                            var row = `
                                <tr>
                                    <td>${car.marka}</td>
                                    <td>${car.model}</td>
                                    <td>${car.plaka}</td>
                                    <td>${car.kiralamaBedeli !== null ? car.kiralamaBedeli : 'N/A'} TL</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-success select-car-btn-tollpass"
                                                data-car-id="${car.id}"
                                                data-car-display="${car.text}">
                                            Seç
                                        </button>
                                    </td>
                                </tr>
                            `;
                            carTableBody.append(row);
                        });
                    } else {
                        carTableBody.append('<tr><td colspan="5" class="text-center">Hiç araç bulunamadı.</td></tr>');
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Otoyol Geçişi Formu - Araçlar yüklenirken bir hata oluştu:", error);
                    $('#carTableBodyTollPass').empty().append('<tr><td colspan="5" class="text-center text-danger">Araçlar yüklenemedi.</td></tr>');
                }
            });
        }

        // Araç Seç butonu click event'i (Otoyol Geçişi Formu için)
        $(document).on('click', '.select-car-btn-tollpass', function () {
            var carId = $(this).data('car-id');
            var carDisplay = $(this).data('car-display');

            $('#SelectedVehicleIdTollPass').val(carId);
            $('#SelectedVehicleDisplayTollPass').val(carDisplay);

            // Seçim yapıldığında unobtrusive validasyon mesajını temizle
            $(`span[data-valmsg-for="AracID"]`).text('');

            $('#carSelectionModalTollPass').modal('hide'); // Modalı kapat
            console.log('Otoyol Geçişi Formu - Araç Seçildi:', { id: carId, display: carDisplay });
        });


        // Müşteri Seçim Modalı Fonksiyonları (Otoyol Geçişi Formu için)
        $('#customerSelectionModalTollPass').on('show.bs.modal', function () {
            console.log('customerSelectionModalTollPass shown, loading customers...');
            loadCustomersTollPass(''); // Modal açıldığında tüm müşterileri yükle
        });

        $('#customerSearchButtonTollPass').on('click', function () {
            var searchTerm = $('#customerSearchInputTollPass').val();
            loadCustomersTollPass(searchTerm);
        });

        $('#customerSearchInputTollPass').on('keyup', function (e) {
            if (e.key === 'Enter') {
                var searchTerm = $(this).val();
                loadCustomersTollPass(searchTerm);
            }
        });

        function loadCustomersTollPass(searchTerm) {
            $.ajax({
                url: '@Url.Action("GetCustomers", "Vehicles")', // VehiclesController'daki GetCustomers metodu
                type: 'GET',
                data: { query: searchTerm },
                success: function (data) {
                    console.log('*** Otoyol Geçişi Formu - Müşteriler AJAX isteği başarılı. Gelen veri:', data);
                    var customerTableBody = $('#customerTableBodyTollPass');
                    customerTableBody.empty();
                    if (data.length > 0) {
                        $.each(data, function (index, customer) {
                            var row = `
                                <tr>
                                    <td>${customer.ad}</td>
                                    <td>${customer.soyad}</td>
                                    <td>${customer.kimlikNo}</td>
                                    <td>${customer.telefon}</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-success select-customer-btn-tollpass"
                                                data-customer-id="${customer.id}"
                                                data-customer-display="${customer.text}">
                                            Seç
                                        </button>
                                    </td>
                                </tr>
                            `;
                            customerTableBody.append(row);
                        });
                    } else {
                        customerTableBody.append('<tr><td colspan="5" class="text-center">Hiç müşteri bulunamadı.</td></tr>');
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Otoyol Geçişi Formu - Müşteriler yüklenirken bir hata oluştu:", error);
                    $('#customerTableBodyTollPass').empty().append('<tr><td colspan="5" class="text-center text-danger">Müşteriler yüklenemedi.</td></tr>');
                }
            });
        }

        // Müşteri Seç butonu click event'i (Otoyol Geçişi Formu için)
        $(document).on('click', '.select-customer-btn-tollpass', function () {
            var customerId = $(this).data('customer-id');
            var customerDisplay = $(this).data('customer-display');

            $('#SelectedCustomerIdTollPass').val(customerId);
            $('#SelectedCustomerDisplayTollPass').val(customerDisplay);

            // Seçim yapıldığında unobtrusive validasyon mesajını temizle
            $(`span[data-valmsg-for="MusteriID"]`).text('');

            $('#customerSelectionModalTollPass').modal('hide'); // Modalı kapat
            console.log('Otoyol Geçişi Formu - Müşteri Seçildi:', { id: customerId, display: customerDisplay });
        });

        // Otoyol geçişi formu offcanvas açıldığında tarih ve validasyonu başlat
        $(document).off('shown.bs.offcanvas.tollpass').on('shown.bs.offcanvas.tollpass', '#newTollPassOffcanvas', function () {
            console.log('newTollPassOffcanvas shown, initializing toll pass form logic...');
            setTollPassDateToToday(); // Geçiş tarihini bugüne ayarla
            // Formun validasyonunu yeniden parse et (offcanvas'a yüklenen form için)
            $.validator.unobtrusive.parse($('#createTollPassForm'));
        });

        // Initial call for toll pass date if form is loaded directly (not via offcanvas)
        setTollPassDateToToday();
    })();
</script>
